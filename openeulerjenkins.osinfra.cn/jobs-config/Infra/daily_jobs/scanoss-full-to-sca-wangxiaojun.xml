<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.42">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.7.1"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.7.1">
      <jobProperties/>
      <triggers/>
      <parameters>
        <string>merge_dir</string>
        <string>branches</string>
      </parameters>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty plugin="build-failure-analyzer@1.27.1">
      <doNotScan>false</doNotScan>
    </com.sonyericsson.jenkins.plugins.bfa.model.ScannerJobProperty>
    <com.gitee.jenkins.connection.GiteeConnectionProperty plugin="gitee@1.2.7">
      <giteeConnection>Gitee</giteeConnection>
    </com.gitee.jenkins.connection.GiteeConnectionProperty>
    <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.31">
      <autoRebuild>false</autoRebuild>
      <rebuildDisabled>false</rebuildDisabled>
    </com.sonyericsson.rebuild.RebuildSettings>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>merge_dir</name>
          <defaultValue>CODE</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>branches</name>
          <defaultValue>master</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers/>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.94">
    <script>#!groovy
import groovy.json.*
def static_result = &apos;success&apos;
def repoUrls = [&apos;https://gitee.com/openeuler/secGear.git&apos;]//,&apos;https://gitee.com/openeuler/A-Tune.git &apos;,&apos;https://gitee.com/openeuler/mugen.git&apos;,&apos;https://gitee.com/openeuler/iSulad.git&apos;

pipeline {
	agent {
		node { 
			label &quot;scanner&quot; 
		}
	}
	parameters {
		string(name: &apos;merge_dir&apos;, defaultValue: &apos;CODE&apos;)
		string(name: &apos;branches&apos;, defaultValue: &apos;master&apos;)
   }
	stages {
		stage (&apos;SCANOSS&apos;)  {
		    agent {
				node { 
					label &quot;scanner&quot; 
				}
			}
			steps (&apos;sonar-steps&apos;) {
				script {
				    cleanWs();
			    	for(int i=0;i&lt;repoUrls.size();i++){
    			        def repoUrl = repoUrls.get(i);
    			        def codeDir = &quot;${merge_dir}_${i}&quot;;
    			        echo &quot;codeDir: ${codeDir}&quot;
    			        echo &quot;repoUrl-wxj: ${repoUrl}&quot;
    			        
    			        //try{
    			            checkout([$class: &apos;GitSCM&apos;, branches: [[name: &apos;*/master&apos;]], extensions: [[$class: &apos;RelativeTargetDirectory&apos;, relativeTargetDir: &quot;${codeDir}&quot;]], userRemoteConfigs: [[credentialsId: &apos;yanxiaobin2020&apos;, 
                        url: &quot;${repoUrl}&quot;]]])   
							
							echo &quot;-------------------wxj parameter info begin-------------------&quot;	  
    						echo &quot;url: &apos;${repoUrl}&apos; \n&quot;
    						echo &quot;relativeTargetDir: &apos;${codeDir}&apos; \n&quot;
    						echo &quot;branches: &apos;${branches}&apos; \n&quot;
    						
    						echo &quot;-------------------wxj parameter info end-------------------&quot;
    							 
    						echo &quot;-------------------deal modify code-------------------&quot;
    						
    						sh  &quot;/usr/bin/python3 /wxj/scanoss_up_bin/scanner/scanoss/scanner.py --blacklist /wxj/config_scanoss/SBOM.json --key cd849a65500b424fc82c6236626ddb1b --apiurl https://shenzhen.scanoss.com/api/scan/direct ${WORKSPACE}/${codeDir} &gt; /var/www/html/${JOB_NAME}--${BUILD_NUMBER}--${i}.json&quot;
    					
    						&quot;curl http://114.116.251.180:30180/${JOB_NAME}--${BUILD_NUMBER}--${i}.json -o fileContent.json&quot;.execute().waitFor()
    						
    						def fileContent = new File(&apos;fileContent.json&apos;).getText().toString()  //直接获取文件内容 json格式
    						
    						def map = [&quot;reposUrl&quot;:&quot;${repoUrl}&quot;,&quot;branch&quot;:&quot;${branches}&quot;,&quot;nativePath&quot;:&quot;${WORKSPACE}/${codeDir}/&quot;,&quot;fileJson&quot;:&quot;${fileContent}&quot;,]
    			            def JsonData = JsonOutput.toJson(map)
    						echo JsonData
    			           
    						def resp = httpRequest contentType: &apos;APPLICATION_JSON&apos;,
    													  httpMode: &quot;POST&quot;,
    													  customHeaders: [
    													  
    													   [name: &quot;Accept&quot;, value: &quot;*/*&quot;],
    													   [name: &quot;Accept-Encoding&quot;, value: &quot;gzip,deflate,br&quot;],
    													   [name: &quot;Connection&quot;, value: &quot;keep-alive&quot;]
    													 ],
    													 requestBody: JsonData,
    													 url: &apos;https://api.osinfra.cn/sca/gateway/scan/upload&apos;  // http://159.138.49.20:39100/api/scan/upload 
    				        def props = readJSON text: resp.content
                            def code = props[&apos;code&apos;]
                            def message = props[&apos;message&apos;]
                            def data = props[&apos;data&apos;]
    				        echo &quot;${code} ${message} ${data}&quot;
    				    
    				        def maps = [&quot;reposUrl&quot;:&quot;${repoUrl}&quot;,&quot;branch&quot;:&quot;${branches}&quot;,&quot;nativePath&quot;:&quot;${WORKSPACE}/${codeDir}/&quot;] //  ,&quot;fileName&quot;:&quot;${data}&quot;,&quot;resultUrl&quot;:&quot;http://114.116.251.180:30180/${JOB_NAME}--${BUILD_NUMBER}--${i}.json&quot;
    				        def JsonDatas = JsonOutput.toJson(maps)
    				        echo JsonDatas
    				        def resps = httpRequest contentType: &apos;APPLICATION_JSON&apos;,
    													  httpMode: &quot;POST&quot;,
    													  customHeaders: [
    													  
    													   [name: &quot;Accept&quot;, value: &quot;*/*&quot;],
    													   [name: &quot;Accept-Encoding&quot;, value: &quot;gzip,deflate,br&quot;],
    													   [name: &quot;Connection&quot;, value: &quot;keep-alive&quot;]
    													 ],
    													 requestBody: JsonDatas,
    													 url: &apos;https://api.osinfra.cn/sca/gateway/scan/save&apos; //http://159.138.49.20:39100/api/scan/save 
                            def propss = readJSON text: resps.content
                            def codes = propss[&apos;code&apos;]
                            def messages = propss[&apos;message&apos;]
                            echo &quot;${codes} ${messages}&quot;
			    	    //}
			    	    //catch(all) {
						   // static_result=sh(returnStdout: true, script: &apos;echo scanoss return failed!!!&apos;)
					    //}
			    	}
				}
			}
		}
	}
} // pipeline end</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>