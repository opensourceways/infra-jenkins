<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.42">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.7.1"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.7.1">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>30</daysToKeep>
        <numToKeep>1000</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <com.gitee.jenkins.connection.GiteeConnectionProperty plugin="gitee@1.1.14">
      <giteeConnection>gitee</giteeConnection>
    </com.gitee.jenkins.connection.GiteeConnectionProperty>
    <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
      <triggers>
        <com.gitee.jenkins.trigger.GiteePushTrigger plugin="gitee@1.1.14">
          <spec></spec>
          <triggerOnPush>false</triggerOnPush>
          <triggerOnOpenPullRequest>true</triggerOnOpenPullRequest>
          <triggerOnPipelineEvent>false</triggerOnPipelineEvent>
          <triggerOnAcceptedPullRequest>false</triggerOnAcceptedPullRequest>
          <triggerOnUpdatePullRequest>0</triggerOnUpdatePullRequest>
          <triggerOnClosedPullRequest>false</triggerOnClosedPullRequest>
          <triggerOnApprovedPullRequest>false</triggerOnApprovedPullRequest>
          <triggerOnTestedPullRequest>false</triggerOnTestedPullRequest>
          <triggerOnNoteRequest>true</triggerOnNoteRequest>
          <noteRegex>/retest</noteRegex>
          <ciSkip>false</ciSkip>
          <skipWorkInProgressPullRequest>false</skipWorkInProgressPullRequest>
          <ciSkipFroTestNotRequired>false</ciSkipFroTestNotRequired>
          <skipLastCommitHasBeenBuild>false</skipLastCommitHasBeenBuild>
          <setBuildDescription>true</setBuildDescription>
          <branchFilterType>All</branchFilterType>
          <includeBranchesSpec></includeBranchesSpec>
          <excludeBranchesSpec></excludeBranchesSpec>
          <targetBranchRegex></targetBranchRegex>
          <secretToken>{AQAAABAAAAAw+f1lNsbEQzCbqb3BAByRUVtFGqY9IfXy9g8DrBUNujLUt2t3kvDQnREjZQbwCbX+Jr8xxtzSBf6qUwm72SiKvw==}</secretToken>
          <cancelPendingBuildsOnUpdate>false</cancelPendingBuildsOnUpdate>
        </com.gitee.jenkins.trigger.GiteePushTrigger>
      </triggers>
    </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.94">
    <script>// define function
def giteeCommentHeader = &quot;| Check Name | Build Result | Build Details |\n| --- | --- | --- |\n&quot;
def addOrRemoveLabel(String OWNER, String PROJECT,String PR_NUMBER,String ACCESS_TOKEN,ArrayList ADD_LABELS,ArrayList REMOVE_LABLES){
    if(!(OWNER?.trim()&amp;&amp;PROJECT?.trim()&amp;&amp;PR_NUMBER?.trim())){
		throw new Exception(&quot;Any of &apos;OWNER&apos;,&apos;PROJECT&apos;,&apos;PR_NUMBER&apos;,&apos;ACCESS_TOKEN&apos; should not be empty&quot;)
	}

	try{
        // Print PR base information
        println &quot;Going to update PR:\nOWNER:$OWNER,PROJECT:$PROJECT,PR_NUMBER:$PR_NUMBER,ADD_LABELS:$ADD_LABELS,REMOVE_LABLES:$REMOVE_LABLES\n&quot;
		
        // Delete PR tag
		REMOVE_LABLES.eachWithIndex{v,index -&gt;
			def requestUrl=sprintf(&quot;https://gitee.com/api/v5/repos/%s/%s/pulls/%s/labels/%s?access_token=%s&quot;,OWNER,PROJECT,PR_NUMBER,v,ACCESS_TOKEN)
			println requestUrl
            println(&quot;-------------------------------------------------------------------------&quot;)
			def response = httpRequest url: requestUrl,
					consoleLogResponseBody: false,
					contentType: &apos;APPLICATION_JSON&apos;,
					customHeaders:[[name: &apos;User-Agent&apos;,value: &apos;MindSpore&apos;]],
					httpMode: &apos;DELETE&apos;,
					ignoreSslErrors: true,
					validResponseCodes: &apos;200:404&apos;
            //println response.status
			return response					
		}

		// Add new PR tag
        println(&quot;###########################################################################&quot;)		
		def requestUrl=sprintf(&quot;https://gitee.com/api/v5/repos/%s/%s/pulls/%s/labels?access_token=%s&quot;,OWNER,PROJECT,PR_NUMBER,ACCESS_TOKEN)
		def prNameStr=ADD_LABELS.join(&apos;,&apos;)
		def updatedLabels=&quot;&quot;&quot;
					[&quot;${prNameStr}&quot;]
					&quot;&quot;&quot;
		println requestUrl
		def response = httpRequest url: requestUrl,
				consoleLogResponseBody: false,
				contentType: &apos;APPLICATION_JSON&apos;,
				customHeaders: [[name: &apos;User-Agent&apos;,value: &apos;MindSpore&apos;]],
				httpMode: &apos;POST&apos;,
				requestBody: updatedLabels,
				ignoreSslErrors: true,
				validResponseCodes: &quot;201&quot;
		return response		
	}catch(Exception ex){
        println &quot;Faild to update PR:\nOWNER:$OWNER,PROJECT:$PROJECT,PR_NUMBER:$PR_NUMBER,ADD_LABELS:$ADD_LABELS,REMOVE_LABLES:$REMOVE_LABLES,$ex\n&quot;
		return false
	}
}

// pipeline workspace
pipeline {
    agent { node { label &apos;website-sync&apos; } }
    environment {
        GITEE_TOKEN = credentials(&apos;gitee_token_id&apos;)
    }

    stages {
        stage(&apos;source code clone&apos;) {
            steps {
			    //移除success、failure的标签,新增running的标签
				addOrRemoveLabel(env.giteeTargetNamespace,env.giteeTargetRepoName,env.giteePullRequestIid,&quot;${GITEE_TOKEN}&quot;,[&quot;ci-pipeline-running&quot;],[&quot;ci-pipeline-passed&quot;,&quot;ci-pipeline-failed&quot;])
				println(&quot;*************************************************************************&quot;)
                checkout([$class: &apos;GitSCM&apos;,
                    branches: [[name: &quot;FETCH_HEAD&quot;]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [[$class: &apos;LocalBranch&apos;], [$class: &apos;RelativeTargetDirectory&apos;, relativeTargetDir: &quot;mindspore.github.io&quot;]],
                    userRemoteConfigs: [[refspec: &quot;+refs/pull/${env.giteePullRequestIid}/MERGE:refs/pull/${env.giteePullRequestIid}/MERGE&quot;,
                    url: &quot;https://I-am-a-robot:${env.GITEE_TOKEN}@gitee.com/mindspore/mindspore.github.io&quot;]]
                ])  
            }
        }

        stage(&apos;build webapp&apos;) {
            steps {
                sh &apos;&apos;&apos;#!/bin/bash
                    cd ${WORKSPACE}/mindspore.github.io/webapp
                    # use cnpm here to speed up the download &amp; install process.
                    npm install
                    npm run build                          
                   &apos;&apos;&apos;
            }
        }

        stage(&apos;build website&apos;) {
            steps {
                sh &apos;&apos;&apos;#!/bin/bash
                    cd ${WORKSPACE}/mindspore.github.io/website
                    mvn clean
                    mvn package                       
                   &apos;&apos;&apos;
            }
        }
    }

    post {
        success {
            script {
                comments = giteeCommentHeader + &quot;| Website Validation | **success** :white_check_mark: | [#${currentBuild.fullDisplayName}](${env.BUILD_URL}/console) | \n&quot;
            }
            addGiteeMRComment comment: comments			
			addOrRemoveLabel(env.giteeTargetNamespace,env.giteeTargetRepoName,env.giteePullRequestIid,&quot;${env.GITEE_TOKEN}&quot;,[&quot;ci-pipeline-passed&quot;],[&quot;ci-pipeline-running&quot;,&quot;ci-pipeline-failed&quot;])
            echo &apos;succeeeded!&apos;
        }

        failure {
            script {
                comments = giteeCommentHeader + &quot;| Website Validation | **failed** :x: | [#${currentBuild.fullDisplayName}](${env.BUILD_URL}/console) | \n&quot;
            }
            addGiteeMRComment comment: comments
			addOrRemoveLabel(env.giteeTargetNamespace,env.giteeTargetRepoName,env.giteePullRequestIid,&quot;${env.GITEE_TOKEN}&quot;,[&quot;ci-pipeline-failed&quot;],[&quot;ci-pipeline-passed&quot;,&quot;ci-pipeline-running&quot;])
            echo &apos;failed!&apos;
        }
    }
}
</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <disabled>false</disabled>
</flow-definition>